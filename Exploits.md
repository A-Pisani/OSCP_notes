# Exploits
## Table of Contents
- [Locating Public Exploits](#locating-public-exploits)
- [Fixing Exploits](#fixing-exploits)
  - [Fixing Memory Corruption Exploits](#fixing-memory-corruption-exploits)
  - [Fixing Web Exploits](#fixing-web-exploits)

## Locating Public Exploits
Places to find exploits:
- https://www.exploit-db.com/
- https://packetstormsecurity.com/files/tags/exploit/
- https://www.securityfocus.com/

Tools for finding exploits:
- Searchsploit: a command line search tool for Exploit-DB

Command Examples:
```sh
root@kali:~# searchsploit -x /usr/share/exploitdb/exploits/windows/remote/43970.rb
```

- Manual for Searchsploit: https://www.exploit-db.com/searchsploit

## Fixing Exploits
### Fixing Memory Corruption Exploits

The general flow of a standard stack overflow is fairly straight-forward. The exploit will:

1. Create a large buffer to trigger the overflow.
2. Take control of EIP by overwriting a return address on the stack by padding the large buffer with an appropriate offset.
3. Include a chosen payload in the buffer prepended by an optional NOP sled.
4. Choose a correct return address instruction such as JMP ESP (or different register) in order to redirect the execution flow into our payload.

### Fixing Web Exploits
When modifying web exploits, there are several key questions we generally need to ask while approaching the code:
- Does it initiate an HTTP or HTTPS connection?
- Does it access a web application specific path or route?
- Does the exploit leverage a pre-authentication vulnerability?
  - If not, how does the exploit authenticate to the web application?
- How are the GET or POST requests crafted to trigger and exploit the vulnerability?
- Does it rely on default application settings (such as the web path of the application) that may have been changed after installation?
- Will oddities such as self-signed certificates disrupt the exploit?

In addition, we must remember that public web application exploits do not take into account additional protections such as .htaccess. This is mainly because the exploit author can not possibly know about these protections during the development process and they are outside the exploit's scope.

#### Selecting the Vulnerability

Let's consider the following scenario. During an assessment we discover a Linux host that has an apache2 server exposed. After enumerating the web server, we find an installation of *CMS Made Simple version 2.2.5* listening on TCP port 443. This version appears to be vulnerable to remote code execution and a [public exploit is available on Exploit-DB](https://www.exploit-db.com/exploits/44976).

This vulnerability is post-authentication, however, we discovered valid application credentials (`admin` / `HUYfaw763`) on another machine during the enumeration process.

#### Changing Connectivity Information

1. As we inspect the code, we realize the `base_url` variable needs to be changed to match our environment:
    ```python
    base_url = "http://192.168.1.10/cmsms/admin"      =>      base_url = "https://10.11.0.128/admin"
    ```
2. We also notice that when browsing the target website, we are presented with a [`SEC_ERROR_UNKNOWN_ISSUER`](https://support.mozilla.org/en-US/kb/error-codes-secure-websites?as=u&utm_source=inproduct) error. This error indicates that the certificate on the remote host can not be validated. We need to account for this in the exploit code.

    Specifically, the exploit is using the `requests` Python library to communicate with the target. The official documentation indicates that the SSL certificate will be ignored if we set the `verify` parameter to `False`:
    ```python
    ...
        response  = requests.post(url, data=data, allow_redirects=False, verify=False)
    ...
        response = requests.post(url, data=data, cookies=cookies, allow_redirects=False, verify=False)
    ```
3. Finally, we also need to change the credentials used in the original exploit to match those found during the enumeration process. These are defined in the username and password variables at lines 15 and 16 respectively:
    ```python
    username = "admin"              =>        username = "admin"
    password = "password"           =>        password = "HUYfaw763"
    ```
